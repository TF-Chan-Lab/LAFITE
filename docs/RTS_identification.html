---

title: tailFinder


keywords: fastai
sidebar: home_sidebar



nb_path: "04_RTS_identification.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 04_RTS_identification.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">interlap</span> <span class="kn">import</span> <span class="n">InterLap</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">strftime</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_score</span>
<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="kn">import</span> <span class="n">GaussianMixture</span>
<span class="kn">from</span> <span class="nn">LAFITE.utils</span> <span class="kn">import</span> <span class="n">Vividict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># ref_exon, ref_junction, ref_single_exon_trans, ref_mutple_exon_trans, left_sj_set, right_sj_set, tss_dict = RefAnnotationExtraction(gtf).annotation_sorting()</span>
<span class="c1"># bed = &#39;/expt/zjzace/Nanopore_subcellular/Analysis/Assembly/LAFITE/GLRA_tmp/A549_Cyto_LAFITE_tmp/bam.bed&#39;</span>
<span class="c1"># fa = &#39;/NFS/mnemosyne2/expt/zjzace/GenomeRef/GRCh38.primary_assembly.genome.fa&#39;</span>
<span class="c1"># junction_dict, processed_read = read_grouping(bed, fa)</span>

<span class="c1"># polya_dict = polya_signal_import(&#39;/expt/zjzace/Nanopore_subcellular/Analysis/Nanopolish/A549_Cyto_PolyA.res&#39;)</span>
<span class="c1"># collected_single_exon_read, collected_multi_exon_read = CoCoWrapper(16, processed_read, ref_exon, ref_junction, ref_single_exon_trans, ref_mutple_exon_trans, left_sj_set, right_sj_set, junction_dict, tmp_dir=&#39;.&#39;, sj_correction_window=40, mis_intron_length = 150, corExcept_dis=4, polya_dict=polya_dict).result_collection()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># gtf = &#39;/expt/zjzace/Nanopore_subcellular/SIRV/SIRV_Set1/Raw_data/SIRV_isoforms_multi-fasta-annotation_C_170612a.gtf&#39;</span>
<span class="c1"># bed = &#39;/expt/zjzace/Nanopore_subcellular/SIRV/SIRV_Set1/bam/SRR6058584.sorted.bed&#39;</span>
<span class="c1"># fa = &#39;/expt/zjzace/Nanopore_subcellular/SIRV/SIRV_Set1/Raw_data/SIRV_isoforms_multi-fasta_170612a.fasta&#39;</span>
<span class="c1"># junction_dict, processed_read = read_grouping(bed, fa)</span>
<span class="c1"># ref_exon, ref_junction, ref_single_exon_trans, ref_mutple_exon_trans, left_sj_set, right_sj_set, tss_dict = RefAnnotationExtraction(gtf).annotation_sorting()</span>

<span class="c1"># # polya_dict = polya_signal_import(&#39;/expt/zjzace/Nanopore_subcellular/SIRV/SIRV_Set1/bam/SRR6058584.polya.res&#39;)</span>
<span class="c1"># polya_dict = PolyAFinder(processed_read, fa, &#39;/home/zjzace/software/SQANTI3-4.1/data/polyA_motifs/mouse_and_human.polyA_motif.txt&#39;).polya_estimation()</span>
<span class="c1"># collected_single_exon_read, collected_multi_exon_read, tss, rss = CoCoWrapper(16, processed_read, ref_exon, ref_junction, ref_single_exon_trans, ref_mutple_exon_trans, left_sj_set, right_sj_set, junction_dict, tmp_dir=&#39;.&#39;, sj_correction_window=40, mis_intron_length = 150, corExcept_dis=4, polya_dict=polya_dict).result_collection()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AlternativeTerminalFinder" class="doc_header"><code>class</code> <code>AlternativeTerminalFinder</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/tailFinder.py#L21" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AlternativeTerminalFinder</code>(<strong><code>chrom</code></strong>, <strong><code>strand</code></strong>, <strong><code>corrected_read_splicing</code></strong>, <strong><code>read_info</code></strong>, <strong><code>min_count_tss_tes</code></strong>, <strong><code>max_sil</code></strong>=<em><code>0</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">AlternativeTerminalFinder</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">corrected_read_splicing</span><span class="p">,</span> <span class="n">read_info</span><span class="p">,</span> <span class="n">min_count_tss_tes</span><span class="p">,</span> <span class="n">max_sil</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">chrom</span> <span class="o">=</span> <span class="n">chrom</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">=</span> <span class="n">strand</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">corrected_read_splicing</span> <span class="o">=</span> <span class="n">corrected_read_splicing</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">polya_lst</span> <span class="o">=</span> <span class="n">read_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">read_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fsm</span> <span class="o">=</span> <span class="n">read_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">collapsed_ID</span> <span class="o">=</span> <span class="n">read_info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">min_count_tss_tes</span> <span class="o">=</span> <span class="n">min_count_tss_tes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_sil</span> <span class="o">=</span> <span class="n">max_sil</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">polya_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polya_lst</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rss_lst</span> <span class="o">=</span> <span class="n">read_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">res_lst</span> <span class="o">=</span> <span class="n">read_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rss_lst</span> <span class="o">=</span> <span class="n">read_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">res_lst</span> <span class="o">=</span> <span class="n">read_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">optimal_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end_list</span><span class="p">):</span>
		<span class="n">max_sil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sil</span>
		<span class="n">k_optimal</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">end_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tts&#39;</span><span class="p">])</span>
		<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">gmm</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
					<span class="n">labels</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
					<span class="n">curr_sil</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">max_sil</span> <span class="o">&lt;</span> <span class="n">curr_sil</span><span class="p">:</span>
						<span class="n">max_sil</span> <span class="o">=</span> <span class="n">curr_sil</span>
						<span class="n">k_optimal</span> <span class="o">=</span> <span class="n">k</span>
				<span class="k">except</span><span class="p">:</span>
					<span class="n">k_optimal</span> <span class="o">=</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span>
					<span class="k">break</span>
		<span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">k_optimal</span>

	<span class="k">def</span> <span class="nf">terminal_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">outlist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chrom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_read_splicing</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polya_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapsed_ID</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tail_lst</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">rss_lst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_lst</span><span class="p">]):</span>

			<span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">min_dis</span> <span class="o">=</span> <span class="mi">50</span>
				<span class="n">polya_lst</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">min_dis</span> <span class="o">=</span> <span class="mi">24</span>
				<span class="n">polya_lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polya_lst</span>

			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tail_lst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">outlist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">tail_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">],[</span><span class="n">tail_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">polya_tag</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">polya_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>
					<span class="n">outlist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">tail_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">tail_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">polya_tag</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">apa_dict</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="n">polya_tag</span> <span class="o">=</span> <span class="kc">False</span>
				<span class="n">df</span><span class="p">,</span> <span class="n">k_optimal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimal_k</span><span class="p">(</span><span class="n">tail_lst</span><span class="p">)</span>
				<span class="n">gmm</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">k_optimal</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
				<span class="n">labels</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
				<span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
				<span class="n">clusters</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">}</span>
				<span class="n">clusters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

				<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">polya_lst</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">:</span>
					<span class="n">df</span><span class="p">[</span><span class="s1">&#39;polya&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polya_lst</span>
					<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;polya&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">)]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">apa_dict</span><span class="p">:</span>
								<span class="n">apa_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
								<span class="k">if</span> <span class="n">apa_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count_tss_tes</span><span class="p">:</span>
									<span class="n">apa_site</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
									<span class="k">for</span> <span class="n">tmp_site</span><span class="p">,</span><span class="n">tmp_count</span> <span class="ow">in</span> <span class="n">apa_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
										<span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tmp_site</span><span class="o">-</span><span class="n">apa_site</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_dis</span> <span class="ow">and</span> <span class="n">apa_count</span> <span class="o">&gt;</span> <span class="n">tmp_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
											<span class="n">apa_dict</span><span class="p">[</span><span class="n">apa_site</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">apa_count</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
											<span class="n">apa_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tmp_site</span><span class="p">)</span>
											<span class="k">break</span>
										<span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tmp_site</span><span class="o">-</span><span class="n">apa_site</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_dis</span> <span class="ow">and</span> <span class="n">apa_count</span> <span class="o">==</span> <span class="n">tmp_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">tmp_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
											<span class="n">apa_dict</span><span class="p">[</span><span class="n">apa_site</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">apa_count</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
											<span class="n">apa_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tmp_site</span><span class="p">)</span>
											<span class="k">break</span>
										<span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tmp_site</span><span class="o">-</span><span class="n">apa_site</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_dis</span><span class="p">:</span>
											<span class="k">pass</span>
											<span class="k">break</span>
										<span class="k">else</span><span class="p">:</span>
											<span class="n">apa_dict</span><span class="p">[</span><span class="n">apa_site</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">apa_count</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="n">apa_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
								<span class="k">if</span> <span class="n">apa_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count_tss_tes</span><span class="p">:</span>
									<span class="n">apa_site</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
									<span class="n">apa_dict</span><span class="p">[</span><span class="n">apa_site</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">apa_count</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">apa_dict</span><span class="p">:</span>
							<span class="n">polya_tag</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">apa_dict</span><span class="p">:</span>
							<span class="n">apa_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
							<span class="k">if</span> <span class="n">apa_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count_tss_tes</span><span class="p">:</span>
								<span class="n">apa_site</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
								<span class="k">for</span> <span class="n">tmp_site</span><span class="p">,</span><span class="n">tmp_count</span> <span class="ow">in</span> <span class="n">apa_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
									<span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tmp_site</span><span class="o">-</span><span class="n">apa_site</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_dis</span> <span class="ow">and</span> <span class="n">apa_count</span> <span class="o">&gt;</span> <span class="n">tmp_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
										<span class="n">apa_dict</span><span class="p">[</span><span class="n">apa_site</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">apa_count</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
										<span class="n">apa_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tmp_site</span><span class="p">)</span>
										<span class="k">break</span>
									<span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tmp_site</span><span class="o">-</span><span class="n">apa_site</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_dis</span> <span class="ow">and</span> <span class="n">apa_count</span> <span class="o">==</span> <span class="n">tmp_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">tmp_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
										<span class="n">apa_dict</span><span class="p">[</span><span class="n">apa_site</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">apa_count</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
										<span class="n">apa_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tmp_site</span><span class="p">)</span>
										<span class="k">break</span>
									<span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tmp_site</span><span class="o">-</span><span class="n">apa_site</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_dis</span><span class="p">:</span>
										<span class="k">pass</span>
										<span class="k">break</span>
									<span class="k">else</span><span class="p">:</span>
										<span class="n">apa_dict</span><span class="p">[</span><span class="n">apa_site</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">apa_count</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">apa_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
							<span class="k">if</span> <span class="n">apa_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count_tss_tes</span><span class="p">:</span>
								<span class="n">apa_site</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
								<span class="n">apa_dict</span><span class="p">[</span><span class="n">apa_site</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">apa_count</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>

				<span class="k">if</span> <span class="n">apa_dict</span><span class="p">:</span>
					<span class="n">apa_site</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">apa_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
					<span class="n">end</span> <span class="o">=</span> <span class="n">apa_site</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">polya_lst</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;polya&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
							<span class="n">polya_tag</span> <span class="o">=</span><span class="kc">True</span>
						<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;tts&#39;</span><span class="p">,</span><span class="s1">&#39;polya&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span>
						<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;tts&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;polya&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span>
						<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tts&#39;</span><span class="p">])</span>
						<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
						<span class="k">if</span> <span class="kc">False</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
							<span class="n">df</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
						<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span>
						<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
							<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;tts&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">])</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;tts&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
						<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tts&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">]</span>
						<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
							<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span><span class="s1">&#39;tts&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span>
						<span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
							<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span><span class="s1">&#39;tts&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">])</span>
					<span class="n">end</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">apa_site</span> <span class="o">=</span> <span class="p">[</span><span class="n">end</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">outlist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">end</span><span class="p">,</span> <span class="n">apa_site</span><span class="p">])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">outlist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">end</span><span class="p">,</span> <span class="n">apa_site</span><span class="p">,</span> <span class="n">polya_tag</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">outlist</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TailFinderWrapper" class="doc_header"><code>class</code> <code>TailFinderWrapper</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/tailFinder.py#L178" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TailFinderWrapper</code>(<strong><code>collected_multi_exon_read</code></strong>, <strong><code>min_count_tss_tes</code></strong>, <strong><code>thread</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TailFinderWrapper</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collected_multi_exon_read</span><span class="p">,</span> <span class="n">min_count_tss_tes</span><span class="p">,</span> <span class="n">thread</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">collected_multi_exon_read</span> <span class="o">=</span> <span class="n">collected_multi_exon_read</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">min_count_tss_tes</span> <span class="o">=</span> <span class="n">min_count_tss_tes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">thread</span>

	<span class="k">def</span> <span class="nf">job_precompute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">precompute_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">),</span> <span class="n">read_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_multi_exon_read</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">corrected_read_splicing</span><span class="p">,</span> <span class="n">read_info</span> <span class="ow">in</span> <span class="n">read_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">precompute_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AlternativeTerminalFinder</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">corrected_read_splicing</span><span class="p">,</span> <span class="n">read_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count_tss_tes</span><span class="p">))</span>
		
		<span class="k">return</span> <span class="n">precompute_list</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">precompute_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_precompute</span><span class="p">()</span>
		<span class="k">with</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">)</span> <span class="k">as</span> <span class="n">parallel</span><span class="p">:</span>
			<span class="n">results_lst</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">terminal_cluster</span><span class="p">())(</span><span class="n">job</span><span class="p">)</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">precompute_list</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">: Calculating pupative TSS and TES for collapsed read&#39;</span><span class="p">))</span>
		
		<span class="k">return</span> <span class="n">results_lst</span>
	
	<span class="k">def</span> <span class="nf">return_extremum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
		
		<span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
			<span class="n">extremum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">extremum</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">extremum</span>

	<span class="k">def</span> <span class="nf">result_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">results_lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
		<span class="n">processed_collected_multi_exon_read</span> <span class="o">=</span> <span class="n">Vividict</span><span class="p">()</span>
		<span class="n">three_prime_exon</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results_lst</span><span class="p">:</span>
			<span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">corrected_read_splicing</span><span class="p">,</span> <span class="n">fsm</span><span class="p">,</span> <span class="n">total_count</span><span class="p">,</span> <span class="n">polya_count</span><span class="p">,</span> <span class="n">collapsed_ID</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">as_site</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">apa_site</span><span class="p">,</span> <span class="n">polya_tag</span> <span class="o">=</span> <span class="n">result</span>
			<span class="n">extremum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_extremum</span><span class="p">(</span><span class="n">strand</span><span class="p">,</span> <span class="n">apa_site</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
				<span class="n">three_prime_exon</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">corrected_read_splicing</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">extremum</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">three_prime_exon</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">extremum</span><span class="p">,</span> <span class="n">corrected_read_splicing</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="n">processed_collected_multi_exon_read</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)][</span><span class="n">corrected_read_splicing</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">total_count</span><span class="p">,</span> <span class="n">polya_count</span><span class="p">,</span> <span class="n">fsm</span><span class="p">,</span> <span class="n">polya_tag</span><span class="p">,</span> <span class="n">as_site</span><span class="p">,</span> <span class="n">apa_site</span><span class="p">,</span> <span class="n">collapsed_ID</span><span class="p">]</span>
		
		<span class="c1"># sort by read exon number</span>

		<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">processed_collected_multi_exon_read</span><span class="p">:</span>
			<span class="n">tmp_dict</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">processed_collected_multi_exon_read</span><span class="p">[</span><span class="n">branch</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
				<span class="n">tmp_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_collected_multi_exon_read</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
			<span class="n">processed_collected_multi_exon_read</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_dict</span>

		<span class="c1"># convert three_prime_exon dict to interlap structure</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">three_prime_exon</span><span class="p">:</span>
			<span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">three_prime_exon</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">three_prime_exon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterLap</span><span class="p">()</span>
			<span class="n">three_prime_exon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">processed_collected_multi_exon_read</span><span class="p">,</span> <span class="n">three_prime_exon</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">processed_collected_multi_exon_read</span><span class="p">,</span> <span class="n">three_prime_exon</span> <span class="o">=</span> <span class="n">TailFinderWrapper</span><span class="p">(</span><span class="n">collected_multi_exon_read</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">result_collection</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2022-04-08 17:17:10: Calculating pupative TSS and TES for collapsed read: 100%|| 4888/4888 [00:09&lt;00:00, 495.06it/s] 
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">reverse_ref</span><span class="p">(</span><span class="n">ref_mutple_exon_trans</span><span class="p">):</span>
	<span class="n">reversed_ref_mutple_exon_trans</span> <span class="o">=</span> <span class="n">Vividict</span><span class="p">()</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">),</span> <span class="n">isoforms</span> <span class="ow">in</span> <span class="n">ref_mutple_exon_trans</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">for</span> <span class="n">isoform</span> <span class="ow">in</span> <span class="n">isoforms</span><span class="p">:</span>
			<span class="n">read_info</span> <span class="o">=</span> <span class="n">isoforms</span><span class="p">[</span><span class="n">isoform</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
				<span class="n">isoform</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">isoform</span><span class="p">))</span>
			<span class="n">reversed_ref_mutple_exon_trans</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)][</span><span class="n">isoform</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_info</span>

	<span class="k">return</span> <span class="n">reversed_ref_mutple_exon_trans</span>

<span class="n">ref_mutple_exon_trans</span> <span class="o">=</span> <span class="n">reverse_ref</span><span class="p">(</span><span class="n">ref_mutple_exon_trans</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">collected_refined_isoforms</span> <span class="o">=</span> <span class="n">RefineWrapper</span><span class="p">(</span><span class="n">processed_collected_multi_exon_read</span><span class="p">,</span> <span class="n">collected_single_exon_read</span><span class="p">,</span> <span class="n">ref_mutple_exon_trans</span><span class="p">,</span> <span class="n">ref_single_exon_trans</span><span class="p">,</span> <span class="n">three_prime_exon</span><span class="p">,</span> <span class="n">tss_dict</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">result_collection</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

